<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>A Workflow for brms • wisclabmisc</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="A Workflow for brms">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">wisclabmisc</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/brms.html">A Workflow for brms</a></li>
    <li><a class="dropdown-item" href="../articles/gamlss-tools.html">Tools for GAMLSS models</a></li>
    <li><a class="dropdown-item" href="../articles/roc.html">Tools for ROC curves</a></li>
    <li><a class="dropdown-item" href="../articles/utterance-length-imputation.html">Utterance length imputation and weighting</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tjmahr/wisclabmisc/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>A Workflow for brms</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tjmahr/wisclabmisc/blob/main/vignettes/articles/brms.Rmd" class="external-link"><code>vignettes/articles/brms.Rmd</code></a></small>
      <div class="d-none name"><code>brms.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms" class="external-link">brms</a></span><span class="op">)</span></span></code></pre></div>
<p><a href="https://paulbuerkner.com/brms/" class="external-link">brms</a> is the premier
Bayesian regression package in R, and we use it in many of our projects.
In this article, I describe the workflow for using brms that I have
<strike>stumbled upon</strike> iterated over our last few analysis
projects.</p>
<div class="section level2">
<h2 id="context-a-set-of-models">Context: A set of models<a class="anchor" aria-label="anchor" href="#context-a-set-of-models"></a>
</h2>
<p>Suppose that we have a dataset of age and intelligibility.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">wisclabmisc</span><span class="fu">::</span><span class="va"><a href="../reference/data_fake_intelligibility.html">data_fake_intelligibility</a></span></span>
<span><span class="va">data</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 200 × 2</span></span></span>
<span><span class="co">#&gt;    age_months intelligibility</span></span>
<span><span class="co">#&gt;         <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>         28           0.539</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>         29           0.375</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>         31           0.221</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>         31           0.253</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>         32           0.276</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>         32           0.750</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>         32           0.820</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>         33           0.325</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>         33           0.446</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>         33           0.592</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 190 more rows</span></span></span></code></pre></div>
<p>We want to fit a <em>set of related models</em>. By “related”, I
loosely mean that the models have the same outcome variable and the same
modeling family. What can vary from model to model are the formulas or
the priors. For example, suppose we want to compare models with
different kinds of age trends using splines:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms" class="external-link">brms</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">splines</span><span class="op">)</span></span>
<span><span class="va">f1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span></span>
<span>  <span class="va">intelligibility</span> <span class="op">~</span> <span class="va">age_months</span>, </span>
<span>  <span class="va">phi</span> <span class="op">~</span> <span class="va">age_months</span>, </span>
<span>  family <span class="op">=</span> <span class="va">Beta</span></span>
<span><span class="op">)</span></span>
<span><span class="va">f2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span></span>
<span>  <span class="va">intelligibility</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">age_months</span>, <span class="fl">2</span><span class="op">)</span>, </span>
<span>  <span class="va">phi</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">age_months</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="va">Beta</span></span>
<span><span class="op">)</span></span>
<span><span class="va">f3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span></span>
<span>  <span class="va">intelligibility</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">age_months</span>, <span class="fl">2</span><span class="op">)</span>, </span>
<span>  <span class="va">phi</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">age_months</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  family <span class="op">=</span> <span class="va">Beta</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Given these model formulas, we could then write a <code><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brm()</a></code>
for each one, but that’s not a good plan. More models could arise as we
start to analyze and critique the results. We might need to set
<code>adapt_delta</code> to a higher value for all the models. Aside
from the formulas, and sometimes the priors, everything about the
model-fitting should generally be the same from model to model.</p>
<p>A solution for this problem to <strong>make a function for fitting
models from the set</strong>. A function provides two wins:</p>
<ol style="list-style-type: decimal">
<li>We can standardize the model fitting across models.</li>
<li>We can indicate the similarity of the models through the
organization of the code. A function tells us “this is where we define
possible age models”.</li>
</ol>
<p>Here is what the workflow looks like at a very high level. We have a
helper function for retrieving priors, a helper function for computing
LOO scores, a helper function for the default/shared arguments to
<code><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brm()</a></code>, and the main function for fitting models from the
set.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lookup_prior</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prior_slug</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># ...</span></span>
<span><span class="op">}</span> </span>
<span></span>
<span><span class="va">add_loo_criterion</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span>, <span class="va">use_reloo</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> </span>
<span>  <span class="co"># ...</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">brm_args</span> <span class="op">&lt;-</span> <span class="fu">wisclabmisc</span><span class="fu">::</span><span class="fu"><a href="../reference/brms_args_create.html">brms_args_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_age_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">data</span>,</span>
<span>    <span class="va">model_slug</span>,</span>
<span>    <span class="va">prior_slug</span> <span class="op">=</span> <span class="st">"default"</span>,</span>
<span>    <span class="va">seed</span> <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    <span class="va">use_reloo</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    <span class="va">...</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># 1. [looking up priors]</span></span>
<span></span>
<span>  <span class="co"># 2. [mapping from model_slug to formula]</span></span>
<span>  </span>
<span>  <span class="co"># 3. [creating a filename]</span></span>
<span>  </span>
<span>  <span class="co"># 4. [fitting model]</span></span>
<span>  </span>
<span>  <span class="co"># 5. [adding LOO score]</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="priors">Priors<a class="anchor" aria-label="anchor" href="#priors"></a>
</h2>
<p>We look up priors by using a helper function. Right now, we don’t
have any different set of priors we want to compare, so there are just
two options: use some weak priors for the logit-scale mu and the
log-scale phi, or use the brms defaults.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lookup_prior</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prior_slug</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span>, dpar <span class="op">=</span> <span class="va">phi</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, dpar <span class="op">=</span> <span class="va">phi</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    brms_default <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">l</span><span class="op">[[</span><span class="va">prior_slug</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Priors are strict (in a good way): I can’t set a prior for a
parameter that doesn’t exist in the model formula. For example, I can’t
set a prior on the random effect variance when the formula doesn’t
include random effects:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/validate_prior.html" class="external-link">validate_prior</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">lookup_prior</span><span class="op">(</span><span class="st">"default"</span><span class="op">)</span>, <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sd"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  formula <span class="op">=</span> <span class="va">f1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Error: The following priors do not correspond to any model parameter: </span></span>
<span><span class="co">#&gt; sd ~ normal(0, 1)</span></span>
<span><span class="co">#&gt; Function 'default_prior' might be helpful to you.</span></span></code></pre></div>
<p>The flipside of this strictness is that I will need to toggle between
priors, for example, when fitting a random-intercept model and a
random-slope model, or when fitting a model with regression splines
<code><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns()</a></code> and a model with a smoothing spline <code><a href="https://paulbuerkner.com/brms/reference/s.html" class="external-link">s()</a></code>.
In my most recent project, I had the following lookup function:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lookup_brms_priors</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prior_slug</span> <span class="op">=</span> <span class="st">"logit_ri"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    logit_ri <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sds</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sd</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    logit_rs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sd</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sds</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">lkj</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">cor</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    logit_phi_ri <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sds</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sd</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, dpar <span class="op">=</span> <span class="va">phi</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    logit_phi_rs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sds</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">sd</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">lkj</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">cor</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, dpar <span class="op">=</span> <span class="va">phi</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">l</span><span class="op">[[</span><span class="va">prior_slug</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>In this case, there were two sets of models: one with a binomial
outcome that used <code>logit_ri</code> and <code>logit_rs</code> and
one with a beta outcome that needed additional priors on the precision
parameter phi via <code>logit_phi_ri</code> and
<code>logit_phi_rs</code>. The <code>_ri</code> and <code>_rs</code>
different in whether they include a prior on the correlation of random
effects.</p>
</div>
<div class="section level2">
<h2 id="a-helper-function-for-loo-computation">A helper function for LOO computation<a class="anchor" aria-label="anchor" href="#a-helper-function-for-loo-computation"></a>
</h2>
<p>I like to compute the LOO score by default. This operation can be
time-consuming, but it fortunately gets cached in the model
<code>file</code> so I just make it part of the model fitting. My
function doesn’t do anything noteworthy other than making it easy to
toggle on exact LOO scores if needed. The <code>reloo</code> argument
gets forwarded to <code><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">brms::loo()</a></code>. If
<code>use_reloo = TRUE</code>, brms refits the model to compute exact
leave-one-out scores for problematic observations.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">add_loo_criterion</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span>, <span class="va">use_reloo</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">use_reloo</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/add_criterion.html" class="external-link">add_criterion</a></span><span class="op">(</span></span>
<span>      <span class="va">x</span>,</span>
<span>      criterion <span class="op">=</span> <span class="st">"loo"</span>,</span>
<span>      reloo <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      recompile <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/add_criterion.html" class="external-link">add_criterion</a></span><span class="op">(</span></span>
<span>      <span class="va">x</span>,</span>
<span>      criterion <span class="op">=</span> <span class="st">"loo"</span>,</span>
<span>      <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>One thing I would like to figure out for my workflow is a smart way
to describe and fit LOGO (leave one group out) models for
repeated-measures models.</p>
</div>
<div class="section level2">
<h2 id="model-fitting-defaults">Model-fitting defaults<a class="anchor" aria-label="anchor" href="#model-fitting-defaults"></a>
</h2>
<p>We usually want knobs and dials of model fitting—number of chains,
number of iterations, Stan backend—to be the same from model-to-model.
So we create a function called <code>brm_args()</code> the prints out a
list of default arguments to <code><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brm()</a></code>. We create this function
using <code><a href="../reference/brms_args_create.html">wisclabmisc::brms_args_create()</a></code>.</p>
<p>Here are the package-provided defaults. (These defaults are just my
preferred settings.)</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">brm_args</span> <span class="op">&lt;-</span> <span class="fu">wisclabmisc</span><span class="fu">::</span><span class="fu"><a href="../reference/brms_args_create.html">brms_args_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">brm_args</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 9</span></span>
<span><span class="co">#&gt;  $ backend   : chr "cmdstanr"</span></span>
<span><span class="co">#&gt;  $ threads   : num 2</span></span>
<span><span class="co">#&gt;  $ chains    : num 4</span></span>
<span><span class="co">#&gt;  $ cores     : num 4</span></span>
<span><span class="co">#&gt;  $ iter      : num 2000</span></span>
<span><span class="co">#&gt;  $ silent    : num 0</span></span>
<span><span class="co">#&gt;  $ file_refit: chr "on_change"</span></span>
<span><span class="co">#&gt;  $ refresh   : num 25</span></span>
<span><span class="co">#&gt;  $ control   : list()</span></span>
<span><span class="co">#&gt;  - attr(*, "class")= chr [1:2] "brm_args" "list"</span></span></code></pre></div>
<p>The interesting ones might be <code>file_refit</code>,
<code>threads</code> and <code>backend</code>. If you provide
<code><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brm()</a></code> with a <code>file</code> like <code>"my-model"</code>
it will save the fitted model into <code>my-model.rds</code>.
<code>file_refit = "on_change"</code> tells brms to refit this model if
the model’s Stan code or data change. By default
<code>file_refit = "never"</code>, meaning that it never refits the
model. I set <code>threads</code> and <code>backend</code> to try to
make the model sample or compile more quickly. I do set
<code>refresh</code> to a small number because I like to see the MCMC
chains sampling.</p>
<p>If these defaults are troublesome (<code>refresh</code>), we can
generate a new <code>brm_args()</code> function with different
defaults.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">brm_args</span> <span class="op">&lt;-</span> <span class="fu">wisclabmisc</span><span class="fu">::</span><span class="fu"><a href="../reference/brms_args_create.html">brms_args_create</a></span><span class="op">(</span>iter <span class="op">=</span> <span class="fl">5000</span>, refresh <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="fu">brm_args</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 9</span></span>
<span><span class="co">#&gt;  $ backend   : chr "cmdstanr"</span></span>
<span><span class="co">#&gt;  $ threads   : num 2</span></span>
<span><span class="co">#&gt;  $ chains    : num 4</span></span>
<span><span class="co">#&gt;  $ cores     : num 4</span></span>
<span><span class="co">#&gt;  $ iter      : num 5000</span></span>
<span><span class="co">#&gt;  $ silent    : num 0</span></span>
<span><span class="co">#&gt;  $ file_refit: chr "on_change"</span></span>
<span><span class="co">#&gt;  $ refresh   : num 100</span></span>
<span><span class="co">#&gt;  $ control   : list()</span></span>
<span><span class="co">#&gt;  - attr(*, "class")= chr [1:2] "brm_args" "list"</span></span></code></pre></div>
<p>These <code>brm_args()</code> function lets us set default
<code><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brm()</a></code> argument values. Importantly, we can deviate from
these defaults if we need to. Here we can overwrite the number of chains
and set a value for <code>adapt_delta</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">brm_args</span><span class="op">(</span>chains <span class="op">=</span> <span class="fl">2</span>, adapt_delta <span class="op">=</span> <span class="fl">.98</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 9</span></span>
<span><span class="co">#&gt;  $ backend   : chr "cmdstanr"</span></span>
<span><span class="co">#&gt;  $ threads   : num 2</span></span>
<span><span class="co">#&gt;  $ chains    : num 2</span></span>
<span><span class="co">#&gt;  $ cores     : num 4</span></span>
<span><span class="co">#&gt;  $ iter      : num 5000</span></span>
<span><span class="co">#&gt;  $ silent    : num 0</span></span>
<span><span class="co">#&gt;  $ file_refit: chr "on_change"</span></span>
<span><span class="co">#&gt;  $ refresh   : num 100</span></span>
<span><span class="co">#&gt;  $ control   :List of 1</span></span>
<span><span class="co">#&gt;   ..$ adapt_delta: num 0.98</span></span>
<span><span class="co">#&gt;  - attr(*, "class")= chr [1:2] "brm_args" "list"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="model-fitting-function">Model fitting function<a class="anchor" aria-label="anchor" href="#model-fitting-function"></a>
</h2>
<p>Now, we can fit a model. Each of the steps in the function are pretty
simple. We are generating and executing a call to <code><a href="https://paulbuerkner.com/brms/reference/brm.html" class="external-link">brm()</a></code>
(via <code><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call()</a></code>) but have to look up the prior and formula
to use, and create a filename for the <code>file</code> argument.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use rstan for the article page</span></span>
<span><span class="va">brm_args</span> <span class="op">&lt;-</span> <span class="fu">wisclabmisc</span><span class="fu">::</span><span class="fu"><a href="../reference/brms_args_create.html">brms_args_create</a></span><span class="op">(</span>backend <span class="op">=</span> <span class="st">"rstan"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_age_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">data</span>,</span>
<span>    <span class="va">model_slug</span>,</span>
<span>    <span class="va">prior_slug</span> <span class="op">=</span> <span class="st">"default"</span>,</span>
<span>    <span class="va">seed</span> <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    <span class="va">use_reloo</span> <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>    <span class="va">...</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># 1. [looking up priors]</span></span>
<span>  <span class="va">prior</span> <span class="op">&lt;-</span> <span class="fu">lookup_prior</span><span class="op">(</span><span class="va">prior_slug</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># 2. [mapping from model_slug to formula]</span></span>
<span>  <span class="va">ns</span> <span class="op">&lt;-</span> <span class="fu">splines</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span></span>
<span>  </span>
<span>  <span class="va">formulas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    linear <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span></span>
<span>      <span class="va">intelligibility</span> <span class="op">~</span> <span class="va">age_months</span>, </span>
<span>      <span class="va">phi</span> <span class="op">~</span> <span class="va">age_months</span>, </span>
<span>      family <span class="op">=</span> <span class="va">Beta</span></span>
<span>    <span class="op">)</span>,</span>
<span>    spline_2df <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span></span>
<span>      <span class="va">intelligibility</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">age_months</span>, <span class="fl">2</span><span class="op">)</span>, </span>
<span>      <span class="va">phi</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">age_months</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      family <span class="op">=</span> <span class="va">Beta</span></span>
<span>    <span class="op">)</span>,</span>
<span>    spline_3df <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span></span>
<span>      <span class="va">intelligibility</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">age_months</span>, <span class="fl">3</span><span class="op">)</span>, </span>
<span>      <span class="va">phi</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">age_months</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>      family <span class="op">=</span> <span class="va">Beta</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">formula</span> <span class="op">&lt;-</span> <span class="va">formulas</span><span class="op">[[</span><span class="va">model_slug</span><span class="op">]</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># 3. [creating a filename]</span></span>
<span>  <span class="va">loo_slug</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">use_reloo</span>, <span class="st">"_reloo"</span>, <span class="st">""</span><span class="op">)</span></span>
<span>  <span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span></span>
<span>    <span class="st">"models"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">model_slug</span>, <span class="st">"_"</span>, <span class="va">prior_slug</span>, <span class="va">loo_slug</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># 4. [fitting model]</span></span>
<span>  <span class="va">args</span> <span class="op">&lt;-</span> <span class="fu">brm_args</span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">formula</span>,</span>
<span>    data <span class="op">=</span> <span class="va">data</span>,</span>
<span>    prior <span class="op">=</span> <span class="va">prior</span>,</span>
<span>    file <span class="op">=</span> <span class="va">file</span>,</span>
<span>    seed <span class="op">=</span> <span class="va">seed</span>,</span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">brm</span>, <span class="va">args</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># 5. [adding LOO score]</span></span>
<span>  <span class="fu">add_loo_criterion</span><span class="op">(</span><span class="va">model</span>, <span class="va">use_reloo</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Let’s fit the models and compare them.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># I'm only using rstan to get the demo to work on GitHub pages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan/" class="external-link">rstan</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: StanHeaders</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; rstan version 2.32.6 (Stan version 2.32.2)</span></span>
<span><span class="co">#&gt; For execution on a local, multicore CPU with excess RAM we recommend calling</span></span>
<span><span class="co">#&gt; options(mc.cores = parallel::detectCores()).</span></span>
<span><span class="co">#&gt; To avoid recompilation of unchanged Stan programs, we recommend calling</span></span>
<span><span class="co">#&gt; rstan_options(auto_write = TRUE)</span></span>
<span><span class="co">#&gt; For within-chain threading using `reduce_sum()` or `map_rect()` Stan functions,</span></span>
<span><span class="co">#&gt; change `threads_per_chain` option:</span></span>
<span><span class="co">#&gt; rstan_options(threads_per_chain = 1)</span></span>
<span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu">fit_age_model</span><span class="op">(</span><span class="va">data</span>, <span class="st">"linear"</span>, seed <span class="op">=</span> <span class="fl">20241023</span><span class="op">)</span></span>
<span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu">fit_age_model</span><span class="op">(</span><span class="va">data</span>, <span class="st">"spline_2df"</span>, seed <span class="op">=</span> <span class="fl">20241023</span><span class="op">)</span></span>
<span><span class="va">m3</span> <span class="op">&lt;-</span> <span class="fu">fit_age_model</span><span class="op">(</span><span class="va">data</span>, <span class="st">"spline_3df"</span>, seed <span class="op">=</span> <span class="fl">20241023</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html" class="external-link">loo_compare</a></span><span class="op">(</span><span class="va">m1</span>, <span class="va">m2</span>, <span class="va">m3</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span>simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;    elpd_diff se_diff elpd_loo se_elpd_loo p_loo  se_p_loo looic  se_looic</span></span>
<span><span class="co">#&gt; m1    0.0       0.0   248.6     14.8         3.2    0.4   -497.3   29.7  </span></span>
<span><span class="co">#&gt; m2   -0.6       2.1   248.0     14.7         4.8    0.6   -496.1   29.4  </span></span>
<span><span class="co">#&gt; m3   -4.1       2.5   244.5     14.9         6.5    0.7   -489.0   29.8</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="the-full-workflow">The full workflow<a class="anchor" aria-label="anchor" href="#the-full-workflow"></a>
</h2>
<p>Here is the full workflow from above, for easy copy-pasting as
boilerplate for new projects. Putting this code chunk in a easy to grab
place is my motivation for writing this article. 🤓</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lookup_prior</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">prior_slug</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">Intercept</span>, dpar <span class="op">=</span> <span class="va">phi</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="va">b</span>, dpar <span class="op">=</span> <span class="va">phi</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    brms_default <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">l</span><span class="op">[[</span><span class="va">prior_slug</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">add_loo_criterion</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span>, <span class="va">use_reloo</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">use_reloo</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/add_criterion.html" class="external-link">add_criterion</a></span><span class="op">(</span></span>
<span>      <span class="va">x</span>,</span>
<span>      criterion <span class="op">=</span> <span class="st">"loo"</span>,</span>
<span>      reloo <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      recompile <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/add_criterion.html" class="external-link">add_criterion</a></span><span class="op">(</span></span>
<span>      <span class="va">x</span>,</span>
<span>      criterion <span class="op">=</span> <span class="st">"loo"</span>,</span>
<span>      <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">brm_args</span> <span class="op">&lt;-</span> <span class="fu">wisclabmisc</span><span class="fu">::</span><span class="fu"><a href="../reference/brms_args_create.html">brms_args_create</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_age_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>    <span class="va">data</span>,</span>
<span>    <span class="va">model_slug</span>,</span>
<span>    <span class="va">prior_slug</span> <span class="op">=</span> <span class="st">"default"</span>,</span>
<span>    <span class="va">seed</span> <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    <span class="va">use_reloo</span> <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>    <span class="va">...</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># 1. [looking up priors]</span></span>
<span>  <span class="va">prior</span> <span class="op">&lt;-</span> <span class="fu">lookup_prior</span><span class="op">(</span><span class="va">prior_slug</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># 2. [mapping from model_slug to formula]</span></span>
<span>  <span class="va">ns</span> <span class="op">&lt;-</span> <span class="fu">splines</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span></span>
<span>  </span>
<span>  <span class="va">formulas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    linear <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span></span>
<span>      <span class="va">intelligibility</span> <span class="op">~</span> <span class="va">age_months</span>, </span>
<span>      <span class="va">phi</span> <span class="op">~</span> <span class="va">age_months</span>, </span>
<span>      family <span class="op">=</span> <span class="va">Beta</span></span>
<span>    <span class="op">)</span>,</span>
<span>    spline_2df <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span></span>
<span>      <span class="va">intelligibility</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">age_months</span>, <span class="fl">2</span><span class="op">)</span>, </span>
<span>      <span class="va">phi</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">age_months</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      family <span class="op">=</span> <span class="va">Beta</span></span>
<span>    <span class="op">)</span>,</span>
<span>    spline_3df <span class="op">=</span> <span class="fu"><a href="https://paulbuerkner.com/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span></span>
<span>      <span class="va">intelligibility</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">age_months</span>, <span class="fl">3</span><span class="op">)</span>, </span>
<span>      <span class="va">phi</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">age_months</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>      family <span class="op">=</span> <span class="va">Beta</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">formula</span> <span class="op">&lt;-</span> <span class="va">formulas</span><span class="op">[[</span><span class="va">model_slug</span><span class="op">]</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># 3. [creating a filename]</span></span>
<span>  <span class="va">loo_slug</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">use_reloo</span>, <span class="st">"_reloo"</span>, <span class="st">""</span><span class="op">)</span></span>
<span>  <span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span></span>
<span>    <span class="st">"models"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">model_slug</span>, <span class="st">"_"</span>, <span class="va">prior_slug</span>, <span class="va">loo_slug</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># 4. [fitting model]</span></span>
<span>  <span class="va">args</span> <span class="op">&lt;-</span> <span class="fu">brm_args</span><span class="op">(</span></span>
<span>    formula <span class="op">=</span> <span class="va">formula</span>,</span>
<span>    data <span class="op">=</span> <span class="va">data</span>,</span>
<span>    prior <span class="op">=</span> <span class="va">prior</span>,</span>
<span>    file <span class="op">=</span> <span class="va">file</span>,</span>
<span>    seed <span class="op">=</span> <span class="va">seed</span>,</span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">brm</span>, <span class="va">args</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># 5. [adding LOO score]</span></span>
<span>  <span class="fu">add_loo_criterion</span><span class="op">(</span><span class="va">model</span>, <span class="va">use_reloo</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Tristan Mahr.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
