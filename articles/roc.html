<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="wisclabmisc">
<title>Tools for ROC curves • wisclabmisc</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Tools for ROC curves">
<meta property="og:description" content="wisclabmisc">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">wisclabmisc</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/gamlss-tools.html">Tools for GAMLSS models</a>
    <a class="dropdown-item" href="../articles/roc.html">Tools for ROC curves</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/tjmahr/wisclabmisc/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">



<script src="roc_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Tools for ROC curves</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tjmahr/wisclabmisc/blob/HEAD/vignettes/roc.Rmd" class="external-link"><code>vignettes/roc.Rmd</code></a></small>
      <div class="d-none name"><code>roc.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tjmahr/wisclabmisc" class="external-link">wisclabmisc</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://expasy.org/tools/pROC/" class="external-link">pROC</a></span>, exclude <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cov"</span>, <span class="st">"smooth"</span>, <span class="st">"var"</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Type 'citation("pROC")' for a citation.</span></code></pre></div>
<div class="section level2">
<h2 id="a-primer-on-roc-curves">A primer on ROC curves<a class="anchor" aria-label="anchor" href="#a-primer-on-roc-curves"></a>
</h2>
<p>wisclabmisc provides functions for tidying results from ROC curves. These curves arise in diagnostic or classification settings where we want to use some test score to determine whether an individual belongs in a <em>control</em> group versus a <em>case</em> group. This binary classification could be normal versus clinical status, regular email versus spam status, and so on. I use the terminology <em>control</em> and <em>case</em> to follow the pROC package’s interface.</p>
<p>In this classification literature, there are tons and tons of statistics to describe classifier performance. The ROC curve centers around the two important quantities of <a href="https://en.wikipedia.org/wiki/Sensitivity_and_specificity" class="external-link"><em>sensitivity</em> and <em>specificity</em></a>:</p>
<ul>
<li>
<strong>sensitivity</strong> is the proportion of true cases correctly identified as cases.
<ul>
<li>Also called the <em>true positive rate</em> or <em>recall.</em>
</li>
<li>If I apply my spam classifier to 100 spam emails, how many will be correctly flagged as spam?</li>
<li>P(case result | case status)</li>
<li>
<em>Sensitivity</em> makes sense to me if I think about the problem as detecting something subtle. (Like a Jedi being “force sensitive” or Spider-Man’s Spidey sense tingling when he’s in danger.)</li>
</ul>
</li>
<li>
<strong>specificity</strong> is the proportion of true controls correctly identified as controls.
<ul>
<li>Also called the <em>true negative rate</em> or <em>selectivity</em>.</li>
<li>If I apply my spam classifier to 100 safe (ham) emails, how many will be correctly ignored?</li>
<li>P(control result | control status)</li>
<li>
<em>Specificity</em> is not a great term; <em>selectivity</em> makes slightly more sense. We don’t want the sensor to trip over noise: It needs to be specific or selective.</li>
</ul>
</li>
</ul>
<p>Suppose our diagnostic instrument provides a score, and we have to choose a diagnostic threshold for one of these scores. For example, suppose we decide that scores above 60 indicate that an email is probably spam and can be moved into the spam folder. Then that threshold will have its own specificity attached to it. We can look at the proportion of spam emails that are equal to or above 60 (sensitivity), and we can look at the proportion of ham emails that are below 60 (specificity). Each number we choose for the threshold will have its own sensitivity and specificity score, so <strong>an ROC curve is a visualization of how sensitivity and specificity change along the range of threshold scores</strong>. (More impenetrable terminology: ROC stands for “receiver operating characteristic”, having something to do with detections made by <a href="https://stats.stackexchange.com/a/398154/14825" title="What is the origin of the “receiver operating characteristic” (ROC) terminology?" class="external-link">radar receivers at different operating levels</a>.)</p>
<div class="section level3">
<h3 id="a-worked-example">A worked example<a class="anchor" aria-label="anchor" href="#a-worked-example"></a>
</h3>
<p>We can work through an example ROC curve using the pROC package. pROC provides the <code>aSAH</code> dataset which provides “several clinical and one laboratory variable of 113 patients with an aneurysmal subarachnoid hemorrhage” (hence, <code>aSAH</code>).</p>
<p>We have the <code>outcome</code> (<code>Good</code> versus <code>Poor</code>) and some measure called <code>s100b</code>. We can see that that are many more <code>Good</code> outcomes near 0 and there are <code>Poor</code> outcomes.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">aSAH</span><span class="op">)</span>
<span class="va">data</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 113 × 7</span></span>
<span class="co">#&gt;    gos6  outcome gender   age wfns  s100b  ndka</span>
<span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;ord&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;ord&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 5     Good    Female    42 1      0.13  3.01</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 5     Good    Female    37 1      0.14  8.54</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 5     Good    Female    42 1      0.1   8.09</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 5     Good    Female    27 1      0.04 10.4 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 1     Poor    Female    42 3      0.13 17.4 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 1     Poor    Male      48 2      0.1  12.8 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 4     Good    Male      57 5      0.47  6   </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 1     Poor    Male      41 4      0.16 13.2 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 5     Good    Female    49 1      0.18 15.5 </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 4     Good    Female    75 2      0.1   6.01</span>
<span class="co">#&gt; <span style="color: #949494;"># … with 103 more rows</span></span>
<span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">outcome</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 2</span></span>
<span class="co">#&gt;   outcome     n</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Good       72</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Poor       41</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">s100b</span>, y <span class="op">=</span> <span class="va">outcome</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>
    position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_jitter.html" class="external-link">position_jitter</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0</span>, height <span class="op">=</span> <span class="fl">.2</span><span class="op">)</span>,
    size <span class="op">=</span> <span class="fl">3</span>,
    alpha <span class="op">=</span> <span class="fl">.2</span>,
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_grey</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></code></pre></div>
<p><img src="roc_files/figure-html/data-points-1.png" width="600"></p>
<p>For each point in a grid of points along <code>s100b</code>, we can compute the proportions of patients in each group above or below that threshold. We can then plot these proportions to visualize the trading relations between specificity and sensitivity as the threshold changes.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">by_outcome</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">data</span><span class="op">$</span><span class="va">outcome</span><span class="op">)</span>
<span class="va">smallest_diff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">s100b</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>
  threshold <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">s100b</span><span class="op">)</span> <span class="op">-</span> <span class="va">smallest_diff</span>, 
    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">s100b</span><span class="op">)</span> <span class="op">+</span> <span class="va">smallest_diff</span>, 
    length.out <span class="op">=</span> <span class="fl">200</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="va">roc_coordinates</span> <span class="op">&lt;-</span> <span class="va">grid</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>
    threshold <span class="op">=</span> <span class="va">threshold</span>,
    prop_poor_above <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">by_outcome</span><span class="op">$</span><span class="va">Poor</span><span class="op">$</span><span class="va">s100b</span> <span class="op">&gt;=</span> <span class="va">threshold</span><span class="op">)</span>,
    prop_good_below <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">by_outcome</span><span class="op">$</span><span class="va">Good</span><span class="op">$</span><span class="va">s100b</span> <span class="op">&lt;</span> <span class="va">threshold</span><span class="op">)</span>,
  <span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">roc_coordinates</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">threshold</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">prop_poor_above</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">prop_good_below</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">2</span>, y <span class="op">=</span> <span class="fl">.9</span>, hjust <span class="op">=</span> <span class="fl">1</span>, label <span class="op">=</span> <span class="st">"specificity"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">2</span>, y <span class="op">=</span> <span class="fl">.1</span>, hjust <span class="op">=</span> <span class="fl">1</span>, label <span class="op">=</span> <span class="st">"sensitivity"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>
    title <span class="op">=</span> <span class="st">"Sensitivity and specificity as cumulative proportions"</span>,
    x <span class="op">=</span> <span class="st">"threshold (diagnosis when score &gt;= threshold)"</span>,
    y <span class="op">=</span> <span class="cn">NULL</span>
  <span class="op">)</span></code></pre></div>
<p><img src="roc_files/figure-html/sens-spec-1.png" width="750"></p>
<p>It took me about 5 tries to get this plot correct. I am able to convince myself by noting that all of the <code>Good</code> outcomes are less than .51 so the threshold should not catch a single <code>Good</code> outcome and hence have specificity of 1. Conversely, there is just <code>Poor</code> outcome above 1, so a threshold of 1 is going to detect 1 <code>Poor</code> outcome and hence have a very low sensitivity.</p>
<p>If we ignore the threshold in our visualization, we can (finally) plot a canonical ROC curve. It shows specificity in reversing order so that the most ideal point is the top left corner (sensitivity = 1, specificity = 1).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">roc_coordinates</span> <span class="op">&lt;-</span> <span class="va">roc_coordinates</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>
    sensitivities <span class="op">=</span> <span class="va">prop_poor_above</span>, 
    specificities <span class="op">=</span> <span class="va">prop_good_below</span>
  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="co"># otherwise the stair-steps look wrong</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">sensitivities</span><span class="op">)</span>

<span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">roc_coordinates</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">specificities</span>, y <span class="op">=</span> <span class="va">sensitivities</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_reverse</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_grey</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span>
<span class="va">p</span></code></pre></div>
<p><img src="roc_files/figure-html/roc-1-1.png" width="450"></p>
<p>We can compare our plot to the one provided by pROC package. We find a perfect match in our sensitivity and specificity values.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">roc</span> <span class="op">&lt;-</span> <span class="fu">pROC</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">data</span>, response <span class="op">=</span> <span class="va">outcome</span>, predictor <span class="op">=</span> <span class="va">s100b</span><span class="op">)</span>
<span class="co">#&gt; Setting levels: control = Good, case = Poor</span>
<span class="co">#&gt; Setting direction: controls &lt; cases</span>
<span class="fu"><a href="https://rdrr.io/pkg/pROC/man/plot.roc.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">roc</span><span class="op">)</span></code></pre></div>
<p><img src="roc_files/figure-html/base-roc-1.png" width="450"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">proc_coordinates</span> <span class="op">&lt;-</span> <span class="va">roc</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">sensitivities</span><span class="op">)</span>

<span class="co"># Plot the pROC point as a wide semi-transparent blue</span>
<span class="co"># band on top of ours</span>
<span class="va">p</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">proc_coordinates</span>, 
    color <span class="op">=</span> <span class="st">"blue"</span>,
    alpha <span class="op">=</span> <span class="fl">.5</span>,
    size <span class="op">=</span> <span class="fl">2</span>
  <span class="op">)</span></code></pre></div>
<p><img src="roc_files/figure-html/base-roc-2.png" width="450"></p>
<p>Instead of computing ROC curves by hand, we defer the calculation of ROC curves to the pROC package because it is easy to get confused when calculating sensitivity and specificity and because pROC provides other tools for working with ROC curves. Thus, wisclabmisc’s goal with ROC curves is to provide helper functions fit ROC curves with pROC and return the results in a nice dataframe.</p>
<p>We contrast two types of ROC curves:</p>
<ul>
<li>an <strong>empirical</strong> ROC curve where the raw data is used to make a jagged ROC curve</li>
<li>a <strong>(smooth) density</strong> ROC curve where the densities of two distributions are used to make a smooth ROC curve.</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="emprical-roc-curves">Emprical ROC curves<a class="anchor" aria-label="anchor" href="#emprical-roc-curves"></a>
</h2>
<p>Let’s return the above example, predicting the group label <code>outcome</code> (case: <code>Poor</code>, control: <code>Good</code>) from the predictor <code>s100b</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu">pROC</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">outcome</span>, <span class="va">s100b</span><span class="op">)</span>
<span class="co">#&gt; Setting levels: control = Good, case = Poor</span>
<span class="co">#&gt; Setting direction: controls &lt; cases</span>
<span class="va">r</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; roc.data.frame(data = data, response = outcome, predictor = s100b)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Data: s100b in 72 controls (outcome Good) &lt; 41 cases (outcome Poor).</span>
<span class="co">#&gt; Area under the curve: 0.7314</span></code></pre></div>
<p>From the messages, we can see that <code><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">pROC::roc()</a></code> makes a few decisions for us: that <code>Good</code> is the <code>control</code> level and <code>Poor</code> is the <code>case</code> level, and that controls should have a lower <code>s100b</code> than cases.</p>
<p><code><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">pROC::roc()</a></code> returns an <code>roc</code> object which bundles all of the data and model results together. Ultimately, we want a the results in a dataframe so that one row will provide the sensitivity and specificity for each threshold value.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">r</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; roc.data.frame(data = data, response = outcome, predictor = s100b)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Data: s100b in 72 controls (outcome Good) &lt; 41 cases (outcome Poor).</span>
<span class="co">#&gt; Area under the curve: 0.7314</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span>
<span class="co">#&gt; [1] "roc"</span>
<span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">r</span>, max.level <span class="op">=</span> <span class="fl">1</span>, give.attr <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">#&gt; List of 15</span>
<span class="co">#&gt;  $ percent           : logi FALSE</span>
<span class="co">#&gt;  $ sensitivities     : num [1:51] 1 0.976 0.976 0.976 0.976 ...</span>
<span class="co">#&gt;  $ specificities     : num [1:51] 0 0 0.0694 0.1111 0.1389 ...</span>
<span class="co">#&gt;  $ thresholds        : num [1:51] -Inf 0.035 0.045 0.055 0.065 ...</span>
<span class="co">#&gt;  $ direction         : chr "&lt;"</span>
<span class="co">#&gt;  $ cases             : num [1:41] 0.13 0.1 0.16 0.12 0.44 0.71 0.49 0.07 0.33 0.09 ...</span>
<span class="co">#&gt;  $ controls          : num [1:72] 0.13 0.14 0.1 0.04 0.47 0.18 0.1 0.1 0.04 0.08 ...</span>
<span class="co">#&gt;  $ fun.sesp          :function (thresholds, controls, cases, direction)  </span>
<span class="co">#&gt;  $ auc               : 'auc' num 0.731</span>
<span class="co">#&gt;  $ call              : language roc.data.frame(data = data, response = outcome, predictor = s100b)</span>
<span class="co">#&gt;  $ original.predictor: num [1:113] 0.13 0.14 0.1 0.04 0.13 0.1 0.47 0.16 0.18 0.1 ...</span>
<span class="co">#&gt;  $ original.response : Factor w/ 2 levels "Good","Poor": 1 1 1 1 2 2 1 2 1 1 ...</span>
<span class="co">#&gt;  $ predictor         : num [1:113] 0.13 0.14 0.1 0.04 0.13 0.1 0.47 0.16 0.18 0.1 ...</span>
<span class="co">#&gt;  $ response          : Factor w/ 2 levels "Good","Poor": 1 1 1 1 2 2 1 2 1 1 ...</span>
<span class="co">#&gt;  $ levels            : chr [1:2] "Good" "Poor"</span></code></pre></div>
<p>We can get close to a dataframe by manipulating the list or by using <code><a href="https://rdrr.io/pkg/pROC/man/coords.html" class="external-link">coords()</a></code>. <code><a href="https://rdrr.io/pkg/pROC/man/coords.html" class="external-link">pROC::coords()</a></code> has additional features that allow it to identify the “best” ROC points, but it strips off useful data like the direction used.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">r</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 51 × 5</span></span>
<span class="co">#&gt;    percent sensitivities specificities thresholds direction</span>
<span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> FALSE           1            0        -<span style="color: #BB0000;">Inf</span>     &lt;        </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> FALSE           0.976        0           0.035 &lt;        </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> FALSE           0.976        0.069<span style="text-decoration: underline;">4</span>      0.045 &lt;        </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> FALSE           0.976        0.111       0.055 &lt;        </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> FALSE           0.976        0.139       0.065 &lt;        </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> FALSE           0.902        0.222       0.075 &lt;        </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> FALSE           0.878        0.306       0.085 &lt;        </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> FALSE           0.829        0.389       0.095 &lt;        </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> FALSE           0.780        0.486       0.105 &lt;        </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span> FALSE           0.756        0.542       0.115 &lt;        </span>
<span class="co">#&gt; <span style="color: #949494;"># … with 41 more rows</span></span>

<span class="fu">pROC</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pROC/man/coords.html" class="external-link">coords</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 51 × 3</span></span>
<span class="co">#&gt;    threshold specificity sensitivity</span>
<span class="co">#&gt;        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>  -<span style="color: #BB0000;">Inf</span>          0            1    </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     0.035      0            0.976</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     0.045      0.069<span style="text-decoration: underline;">4</span>       0.976</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     0.055      0.111        0.976</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     0.065      0.139        0.976</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     0.075      0.222        0.902</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     0.085      0.306        0.878</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     0.095      0.389        0.829</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     0.105      0.486        0.780</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     0.115      0.542        0.756</span>
<span class="co">#&gt; <span style="color: #949494;"># … with 41 more rows</span></span></code></pre></div>
<p>wisclabmisc provides <code><a href="../reference/compute_empirical_roc.html">compute_empirical_roc()</a></code> which combines results from <code><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">pROC::roc()</a></code> and <code><a href="https://rdrr.io/pkg/pROC/man/coords.html" class="external-link">pROC::coords()</a></code> into a tibble. It includes metadata about the <code>.controls</code> and <code>.cases</code> levels, the <code>.direction</code> of the relationship, and the overall <code>.auc</code> of the curve. It also identifies two “best” coordinates with <code>.is_best_youden</code> and <code>is_best_closest_topleft</code>. Finally, it retains the name of the predictor variable.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/compute_empirical_roc.html">compute_empirical_roc</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">outcome</span>, <span class="va">s100b</span><span class="op">)</span>
<span class="co">#&gt; Setting levels: control = Good, case = Poor</span>
<span class="co">#&gt; Setting direction: controls &lt; cases</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 51 × 9</span></span>
<span class="co">#&gt;       s100b .specificities .sensitivities  .auc .direction .controls .cases</span>
<span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> -<span style="color: #BB0000;">Inf</span>             0               1     0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>    0.035         0               0.976 0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>    0.045         0.069<span style="text-decoration: underline;">4</span>          0.976 0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>    0.055         0.111           0.976 0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>    0.065         0.139           0.976 0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>    0.075         0.222           0.902 0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>    0.085         0.306           0.878 0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>    0.095         0.389           0.829 0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>    0.105         0.486           0.780 0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    0.115         0.542           0.756 0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #949494;"># … with 41 more rows, and 2 more variables: .is_best_youden &lt;lgl&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   .is_best_closest_topleft &lt;lgl&gt;</span></span></code></pre></div>
<p>We can still see the messages emitted by the <code><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">pROC::roc()</a></code> call when we use <code><a href="../reference/compute_empirical_roc.html">compute_empirical_roc()</a></code>. We can pass the arguments <code>direction</code> and <code>levels</code> to <code><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">pROC::roc()</a></code> to silence these messages.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_roc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_empirical_roc.html">compute_empirical_roc</a></span><span class="op">(</span>
  <span class="va">data</span>, 
  <span class="va">outcome</span>, 
  <span class="va">s100b</span>, 
  direction <span class="op">=</span> <span class="st">"&lt;"</span>,
  levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Good"</span>, <span class="st">"Poor"</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">data_roc</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 51 × 9</span></span>
<span class="co">#&gt;       s100b .specificities .sensitivities  .auc .direction .controls .cases</span>
<span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> -<span style="color: #BB0000;">Inf</span>             0               1     0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>    0.035         0               0.976 0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>    0.045         0.069<span style="text-decoration: underline;">4</span>          0.976 0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>    0.055         0.111           0.976 0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>    0.065         0.139           0.976 0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>    0.075         0.222           0.902 0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>    0.085         0.306           0.878 0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>    0.095         0.389           0.829 0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>    0.105         0.486           0.780 0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    0.115         0.542           0.756 0.731 &lt;          Good      Poor  </span>
<span class="co">#&gt; <span style="color: #949494;"># … with 41 more rows, and 2 more variables: .is_best_youden &lt;lgl&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   .is_best_closest_topleft &lt;lgl&gt;</span></span></code></pre></div>
<p>According to the help page for <code><a href="https://rdrr.io/pkg/pROC/man/coords.html" class="external-link">pROC::coords()</a></code> is Youden’s J statistic is the point that is farthest vertical distance from the diagonal line. The other “best” point is the point closest to the upper-left corner. The following plot labels each of these distances. The Youden’s point and the topleft point here are the same point.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_roc</span> <span class="op">&lt;-</span> <span class="va">data_roc</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">.sensitivities</span><span class="op">)</span>

<span class="va">p_best</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data_roc</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.specificities</span>, y <span class="op">=</span> <span class="va">.sensitivities</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>
    slope <span class="op">=</span> <span class="fl">1</span>, 
    intercept <span class="op">=</span> <span class="fl">1</span>, 
    linetype <span class="op">=</span> <span class="st">"dotted"</span>, 
    color <span class="op">=</span> <span class="st">"grey20"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xend <span class="op">=</span> <span class="va">.specificities</span>, yend <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">.specificities</span><span class="op">)</span>,
    data <span class="op">=</span> <span class="va">.</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.is_best_youden</span><span class="op">)</span>,
    color <span class="op">=</span> <span class="st">"blue"</span>,
    linetype <span class="op">=</span> <span class="st">"dashed"</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xend <span class="op">=</span> <span class="fl">1</span>, yend <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
    data <span class="op">=</span> <span class="va">.</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.is_best_closest_topleft</span><span class="op">)</span>,
    color <span class="op">=</span> <span class="st">"maroon"</span>,
    linetype <span class="op">=</span> <span class="st">"dashed"</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="co"># Basically, finding a point 9/10ths of the way</span>
  <span class="co"># along the line</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>
      x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">.specificities</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">9</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, 
      y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">.sensitivities</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">9</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, 
    <span class="op">)</span>,
    data <span class="op">=</span> <span class="va">.</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.is_best_closest_topleft</span><span class="op">)</span>,
    color <span class="op">=</span> <span class="st">"maroon"</span>,
    label <span class="op">=</span> <span class="st">"closest to topleft"</span>,
    hjust <span class="op">=</span> <span class="fl">0</span>, 
    nudge_x <span class="op">=</span> <span class="fl">.02</span>,
    size <span class="op">=</span> <span class="fl">5</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>
      x <span class="op">=</span> <span class="va">.specificities</span>, 
      y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html" class="external-link">weighted.mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">.specificities</span>, <span class="va">.sensitivities</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, 
    <span class="op">)</span>,
    data <span class="op">=</span> <span class="va">.</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.is_best_youden</span><span class="op">)</span>,
    color <span class="op">=</span> <span class="st">"blue"</span>,
    label <span class="op">=</span> <span class="st">"Youden's J\n(max height above diagonal)"</span>,
    hjust <span class="op">=</span> <span class="fl">0</span>,
    vjust <span class="op">=</span> <span class="fl">.5</span>,
    nudge_x <span class="op">=</span> <span class="fl">.02</span>,
    size <span class="op">=</span> <span class="fl">5</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>
    <span class="st">"text"</span>,
    x <span class="op">=</span> <span class="fl">.91</span>,
    y <span class="op">=</span> <span class="fl">.05</span>,
    hjust <span class="op">=</span> <span class="fl">0</span>, 
    size <span class="op">=</span> <span class="fl">5</span>,
    label <span class="op">=</span> <span class="st">"diagonal: random classifier"</span>,
    color <span class="op">=</span> <span class="st">"grey20"</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_reverse</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_grey</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>
<span class="va">p_best</span></code></pre></div>
<p><img src="roc_files/figure-html/roc-annotated-1.png" width="1093.75"></p>
</div>
<div class="section level2">
<h2 id="smooth-density-roc-curves">(Smooth) density ROC curves<a class="anchor" aria-label="anchor" href="#smooth-density-roc-curves"></a>
</h2>
<p>Instead of looking at the observed data, let’s assume the <code>s100b</code> values in each group are drawn from a normal distribution but the means and scales (standard deviations) are different for the two groups. We can compute each group’s mean and standard deviation and then plot the normal density curves on top of each other. Pepe (2003) refers to this approach as the “binormal ROC curve”.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_stats</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>
    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">s100b</span><span class="op">)</span>,
    sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">s100b</span><span class="op">)</span>
  <span class="op">)</span> 

<span class="va">l_control</span> <span class="op">&lt;-</span> <span class="va">data_stats</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">==</span> <span class="st">"Good"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">l_case</span> <span class="op">&lt;-</span> <span class="va">data_stats</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">!=</span> <span class="st">"Good"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">s100b</span>, color <span class="op">=</span> <span class="va">outcome</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co"># include a "rug" at the bottom</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html" class="external-link">geom_jitter</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="op">-</span><span class="fl">.2</span><span class="op">)</span>, width <span class="op">=</span> <span class="fl">0</span>, height <span class="op">=</span> <span class="fl">.15</span>, alpha <span class="op">=</span> <span class="fl">.4</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">stat_function</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">.</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">==</span> <span class="st">"Good"</span><span class="op">)</span>,
    fun <span class="op">=</span> <span class="va">dnorm</span>, 
    args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="va">l_control</span><span class="op">$</span><span class="va">mean</span>, sd <span class="op">=</span> <span class="va">l_control</span><span class="op">$</span><span class="va">sd</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">stat_function</a></span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">.</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">outcome</span> <span class="op">!=</span> <span class="st">"Good"</span><span class="op">)</span>,
    fun <span class="op">=</span> <span class="va">dnorm</span>, 
    args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="va">l_case</span><span class="op">$</span><span class="va">mean</span>, sd <span class="op">=</span> <span class="va">l_case</span><span class="op">$</span><span class="va">sd</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">mean</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">mean</span>, <span class="va">mean</span>, <span class="va">sd</span><span class="op">)</span>, label <span class="op">=</span> <span class="va">outcome</span><span class="op">)</span>,
    data <span class="op">=</span> <span class="va">data_stats</span>,
    vjust <span class="op">=</span> <span class="st">"inward"</span>,
    hjust <span class="op">=</span> <span class="fl">0</span>,
    nudge_x <span class="op">=</span> <span class="fl">.05</span>,
    nudge_y <span class="op">=</span> <span class="fl">.05</span>,
    size <span class="op">=</span> <span class="fl">4</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_grey</a></span><span class="op">(</span><span class="fl">14</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span>, legend.justification <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></code></pre></div>
<p><img src="roc_files/figure-html/data-points-2-1.png" width="600"></p>
<p>At various points along the <em>x</em>-axis range, <code><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">stat_function()</a></code> compute <code><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm()</a></code> (the density of the normal curves). We can do that by hand too. We take the full range of the data, and then within each group, generate a set of points along that range and compute that group’s density at each point.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_grid</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>
    xmin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">s100b</span><span class="op">)</span>,
    xmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">s100b</span><span class="op">)</span>
  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">outcome</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">xmin</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">xmax</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, length.out <span class="op">=</span> <span class="fl">200</span><span class="op">)</span>,
    group_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">s100b</span><span class="op">)</span>,
    group_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">s100b</span><span class="op">)</span>,
    density <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">group_mean</span>, <span class="va">group_sd</span><span class="op">)</span>,
    .groups <span class="op">=</span> <span class="st">"drop"</span>
  <span class="op">)</span> 
<span class="va">data_grid</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 400 × 5</span></span>
<span class="co">#&gt;    outcome      x group_mean group_sd density</span>
<span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Good    0.03        0.162    0.131    1.84</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Good    0.040<span style="text-decoration: underline;">3</span>      0.162    0.131    1.98</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Good    0.050<span style="text-decoration: underline;">5</span>      0.162    0.131    2.13</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Good    0.060<span style="text-decoration: underline;">8</span>      0.162    0.131    2.27</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Good    0.071<span style="text-decoration: underline;">0</span>      0.162    0.131    2.40</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Good    0.081<span style="text-decoration: underline;">3</span>      0.162    0.131    2.53</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Good    0.091<span style="text-decoration: underline;">5</span>      0.162    0.131    2.64</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Good    0.102       0.162    0.131    2.75</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Good    0.112       0.162    0.131    2.84</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Good    0.122       0.162    0.131    2.91</span>
<span class="co">#&gt; <span style="color: #949494;"># … with 390 more rows</span></span></code></pre></div>
<p>Next, we pivot to a wide pivot format because we will be comparing the two densities at each point.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_dens</span> <span class="op">&lt;-</span> <span class="va">data_grid</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>s100b <span class="op">=</span> <span class="va">x</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">group_mean</span>, <span class="op">-</span><span class="va">group_sd</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">outcome</span>, values_from <span class="op">=</span> <span class="va">density</span><span class="op">)</span>
<span class="va">data_dens</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 200 × 3</span></span>
<span class="co">#&gt;     s100b  Good  Poor</span>
<span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 0.03    1.84 0.659</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 0.040<span style="text-decoration: underline;">3</span>  1.98 0.676</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 0.050<span style="text-decoration: underline;">5</span>  2.13 0.694</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 0.060<span style="text-decoration: underline;">8</span>  2.27 0.711</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 0.071<span style="text-decoration: underline;">0</span>  2.40 0.729</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 0.081<span style="text-decoration: underline;">3</span>  2.53 0.746</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 0.091<span style="text-decoration: underline;">5</span>  2.64 0.763</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 0.102   2.75 0.780</span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 0.112   2.84 0.797</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 0.122   2.91 0.813</span>
<span class="co">#&gt; <span style="color: #949494;"># … with 190 more rows</span></span></code></pre></div>
<p><code><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">pROC::roc()</a></code> can compute an ROC curve from these densities. Note that the interface here is different. We do not provide a dataframe and names of columns in that data frame. Instead, we provide two vectors of densities, and in fact, those densities are lost after computing the ROC curve.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_dens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">data_dens</span>, <span class="va">s100b</span><span class="op">)</span>
<span class="va">r_dens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">roc</a></span><span class="op">(</span>
  density.controls <span class="op">=</span> <span class="va">data_dens</span><span class="op">$</span><span class="va">Good</span>, 
  density.cases <span class="op">=</span> <span class="va">data_dens</span><span class="op">$</span><span class="va">Poor</span>
<span class="op">)</span>
<span class="va">r_dens</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt; roc.default(density.controls = data_dens$Good, density.cases = data_dens$Poor)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Smoothing: density with controls: data_dens$Good; and cases: data_dens$Poor</span>
<span class="co">#&gt; Area under the curve: 0.8299</span>
<span class="fu"><a href="https://rdrr.io/pkg/pROC/man/plot.roc.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">r_dens</span><span class="op">)</span></code></pre></div>
<p><img src="roc_files/figure-html/smooth-roc-1.png" width="450"></p>
<p>The <code>roc</code> object here returns the coordinates with sensitivity in decreasing order, so it is not obvious how to map these sensitivities back to the original densities. In terms of the earlier density plot, we don’t know whether the sensitivities move up the <em>x</em> axis or down the <em>x</em> axis.</p>
<p>Let’s restate the problem again, for clarity:</p>
<ul>
<li>We want to map thresholds to densities to ROC coordinates and map ROC coordinates back to densities to thresholds.</li>
<li>With <code>pROC::roc(density.controls, density.controls)</code>, we hit a brick wall and cannot map backwards from ROC coordinates because the sensitivites may have been reversed with respect to the densities.</li>
</ul>
<p>Fortunately, if we compute the sensitivities by hand, we can figure out how the coordinates were ordered. We try both orderings and find the one that best matches one provided by <code><a href="https://rdrr.io/pkg/pROC/man/roc.html" class="external-link">pROC::roc()</a></code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># direction &gt; : Good &gt; threshold &gt;= Poor</span>
<span class="va">sens_gt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">data_dens</span><span class="op">$</span><span class="va">Poor</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_dens</span><span class="op">$</span><span class="va">Poor</span><span class="op">)</span><span class="op">)</span>
<span class="co"># direction &lt; : Good &lt; threshold &lt;= Poor</span>
<span class="va">sens_lt</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">data_dens</span><span class="op">$</span><span class="va">Poor</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_dens</span><span class="op">$</span><span class="va">Poor</span><span class="op">)</span><span class="op">)</span>
<span class="co"># The model did ??</span>
<span class="va">fitted_sensitivities</span> <span class="op">&lt;-</span> <span class="va">r_dens</span><span class="op">$</span><span class="va">sensitivities</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">201</span><span class="op">)</span><span class="op">]</span>

<span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">fitted_sensitivities</span> <span class="op">-</span> <span class="va">sens_lt</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.004999997</span>
<span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">fitted_sensitivities</span> <span class="op">-</span> <span class="va">sens_gt</span><span class="op">)</span>
<span class="co">#&gt; [1] -0.530585</span></code></pre></div>
<p>Because the <code>&lt;</code> direction better matched the ROC results, we conclude that the sensitivities follow the same order as the densities.</p>
<p><code><a href="../reference/compute_smooth_density_roc.html">compute_smooth_density_roc()</a></code> uses a similar heuristic to determine the order of the ROC coordinates with respect to the original densities. As a result, we can map the original threshold values to sensitivity and specificity values. The function also lets us use column names directly.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_smooth</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_smooth_density_roc.html">compute_smooth_density_roc</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">data_dens</span>, 
  controls <span class="op">=</span> <span class="va">Good</span>, 
  cases <span class="op">=</span> <span class="va">Poor</span>, 
  along <span class="op">=</span> <span class="va">s100b</span>
<span class="op">)</span>
<span class="va">data_smooth</span>
<span class="co">#&gt; <span style="color: #949494;"># A tibble: 202 × 10</span></span>
<span class="co">#&gt;     s100b  Good  Poor .sensitivities .specificities  .auc .roc_row .direction</span>
<span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 0.03    1.84 0.659          1             0      0.830        2 &lt;         </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 0.040<span style="text-decoration: underline;">3</span>  1.98 0.676          0.992         0.022<span style="text-decoration: underline;">1</span> 0.830        3 &lt;         </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 0.050<span style="text-decoration: underline;">5</span>  2.13 0.694          0.984         0.046<span style="text-decoration: underline;">0</span> 0.830        4 &lt;         </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 0.060<span style="text-decoration: underline;">8</span>  2.27 0.711          0.975         0.071<span style="text-decoration: underline;">6</span> 0.830        5 &lt;         </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 0.071<span style="text-decoration: underline;">0</span>  2.40 0.729          0.967         0.098<span style="text-decoration: underline;">9</span> 0.830        6 &lt;         </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 0.081<span style="text-decoration: underline;">3</span>  2.53 0.746          0.958         0.128  0.830        7 &lt;         </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 0.091<span style="text-decoration: underline;">5</span>  2.64 0.763          0.949         0.158  0.830        8 &lt;         </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 0.102   2.75 0.780          0.939         0.190  0.830        9 &lt;         </span>
<span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 0.112   2.84 0.797          0.930         0.223  0.830       10 &lt;         </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 0.122   2.91 0.813          0.920         0.257  0.830       11 &lt;         </span>
<span class="co">#&gt; <span style="color: #949494;"># … with 192 more rows, and 2 more variables: .is_best_youden &lt;lgl&gt;,</span></span>
<span class="co">#&gt; <span style="color: #949494;">#   .is_best_closest_topleft &lt;lgl&gt;</span></span></code></pre></div>
<p><code><a href="../reference/compute_smooth_density_roc.html">compute_smooth_density_roc()</a></code> also provides coordinates for the “best” thresholds by the Youden or topleft criteria. Because of the consistency between the two functions, we can just replace the data used to make annotated ROC curve with the smoothed ROC coordinates. In this case, the Youden and topleft points are different.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">p_best</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">data_smooth</span><span class="op">)</span></code></pre></div>
<p><img src="roc_files/figure-html/roc-annotated-smooth-1.png" width="1093.75"></p>
<p>As a final demonstration, let’s compare the smooth and empirical ROC sensitivity and specificity values along the threshold values.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data_smooth</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">s100b</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"smooth"</span>, linetype <span class="op">=</span> <span class="st">"smooth"</span>, y <span class="op">=</span> <span class="va">.sensitivities</span><span class="op">)</span>,
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"empirical"</span>, linetype <span class="op">=</span> <span class="st">"smooth"</span>, y <span class="op">=</span> <span class="va">.sensitivities</span><span class="op">)</span>,
    data <span class="op">=</span> <span class="va">data_roc</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"smooth"</span>, linetype <span class="op">=</span> <span class="st">"empirical"</span>, y <span class="op">=</span> <span class="va">.specificities</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"empirical"</span>, linetype <span class="op">=</span> <span class="st">"empirical"</span>, y <span class="op">=</span> <span class="va">.specificities</span><span class="op">)</span>,
    data <span class="op">=</span> <span class="va">data_roc</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">2</span>, y <span class="op">=</span> <span class="fl">.9</span>, hjust <span class="op">=</span> <span class="fl">1</span>, label <span class="op">=</span> <span class="st">"specificity"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="fl">2</span>, y <span class="op">=</span> <span class="fl">.1</span>, hjust <span class="op">=</span> <span class="fl">1</span>, label <span class="op">=</span> <span class="st">"sensitivity"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>
    color <span class="op">=</span> <span class="st">"ROC type"</span>, 
    linetype <span class="op">=</span> <span class="st">"ROC type"</span>,
    y <span class="op">=</span> <span class="cn">NULL</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_grey</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span>
<span class="co">#&gt; Warning: Removed 2 row(s) containing missing values (geom_path).</span>
<span class="co">#&gt; Removed 2 row(s) containing missing values (geom_path).</span></code></pre></div>
<p><img src="roc_files/figure-html/another-comparison-1.png" width="600"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Tristan Mahr.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.5.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
